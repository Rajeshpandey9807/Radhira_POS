@{
    ViewData["Title"] = "Bulk upload parties";
}

@section Styles {
    <link rel="stylesheet" href="~/css/business-profile.css" asp-append-version="true" />
}

<section class="users-header">
    <div>
        <p class="eyebrow">Parties</p>
        <h2>Bulk upload</h2>
        <p>Upload a CSV to create multiple parties at once. You can download the template, fill it, and import.</p>
    </div>
    <div class="hero-actions">
        <a class="btn ghost" asp-action="Index">Back</a>
        <a class="btn primary" asp-action="ImportTemplate">Download template</a>
        <a class="btn ghost" href="~/samples/party-upload-sample.csv">Download sample</a>
    </div>
</section>

<form asp-action="Import" method="post" enctype="multipart/form-data" class="card-form" data-import-form>
    @Html.AntiForgeryToken()
    <div class="form-grid">
        <div class="field-group span-all bp-file">
            <label for="PartyCsvFile">CSV file</label>
            <input id="PartyCsvFile" name="file" type="file" accept=".csv,text/csv" />
            <small class="bp-help">
                Required columns: PartyName, PartyType, PartyCategory. Dates can be like 2025-12-14.
            </small>
            <span data-import-error></span>
        </div>
    </div>

    <div class="form-actions">
        <button class="btn primary" type="submit">Upload &amp; Import</button>
    </div>
</form>

<div class="trend-card" style="margin-top: 18px; display:none;" data-import-results>
    <header>
        <h3 style="margin: 0;">Import results</h3>
        <span style="color: rgba(255,255,255,0.65); font-weight: 600;" data-import-summary></span>
    </header>
    <div style="overflow:auto;">
        <table class="modern-table" style="margin-top: 12px;">
            <thead>
                <tr>
                    <th>Row</th>
                    <th>Party</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody data-import-rows></tbody>
        </table>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const toast = (message, isError) => {
                const node = document.createElement('div');
                node.className = 'toast' + (isError ? ' is-error' : '');
                node.textContent = message || (isError ? 'Something went wrong.' : 'Done.');
                document.body.appendChild(node);
                setTimeout(() => node.classList.add('hide'), 3200);
                setTimeout(() => node.remove(), 3800);
            };

            const form = document.querySelector('[data-import-form]');
            const errorNode = document.querySelector('[data-import-error]');
            const resultsCard = document.querySelector('[data-import-results]');
            const summaryNode = document.querySelector('[data-import-summary]');
            const rowsNode = document.querySelector('[data-import-rows]');
            if (!form || !resultsCard || !summaryNode || !rowsNode) return;

            const escapeHtml = (s) => String(s || '').replace(/[&<>"']/g, (ch) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[ch]));

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (errorNode) errorNode.textContent = '';
                rowsNode.innerHTML = '';
                resultsCard.style.display = 'none';

                const fd = new FormData(form);
                const file = fd.get('file');
                if (!file || !(file instanceof File) || file.size === 0) {
                    if (errorNode) errorNode.textContent = 'Please choose a CSV file.';
                    toast('Please choose a CSV file.', true);
                    return;
                }

                try {
                    const res = await fetch(form.getAttribute('action') || window.location.href, {
                        method: 'POST',
                        body: fd,
                        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const payload = await res.json().catch(() => null);
                    if (!res.ok) {
                        const msg = (payload && payload.message) || 'Import failed.';
                        if (errorNode) errorNode.textContent = msg;
                        toast(msg, true);
                        return;
                    }

                    const summary = (payload && payload.message) || 'Import completed.';
                    summaryNode.textContent = summary;
                    resultsCard.style.display = 'block';

                    const items = (payload && payload.results) || [];
                    items.forEach((it) => {
                        const ok = !!it.ok;
                        const errors = Array.isArray(it.errors) ? it.errors : [];
                        const partyId = it.partyId;
                        const details = ok
                            ? (partyId ? ('Created PartyId ' + partyId) : 'Created')
                            : (errors.length ? errors.join(' | ') : 'Failed');
                        const status = ok ? 'Success' : 'Failed';

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(it.row)}</td>
                            <td>${escapeHtml(it.partyName || '-')}</td>
                            <td>${ok ? '<span class="status-pill online">Success</span>' : '<span class="status-pill offline">Failed</span>'}</td>
                            <td>${escapeHtml(details)}</td>
                        `;
                        rowsNode.appendChild(tr);
                    });

                    toast(summary, false);
                } catch (err) {
                    toast('Network error while importing. Please try again.', true);
                }
            });
        })();
    </script>
}

