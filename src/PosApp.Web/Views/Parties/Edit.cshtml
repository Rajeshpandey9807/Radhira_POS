@model PartyEditRequest
@{
    ViewData["Title"] = "Edit party";
}

@section Styles {
    <link rel="stylesheet" href="~/css/business-profile.css" asp-append-version="true" />
}

<section class="users-header">
    <div>
        <p class="eyebrow">Parties</p>
        <h2>Edit party</h2>
        <p>Update party details used across invoices, payments, and reports.</p>
    </div>
</section>

<form asp-action="Edit" asp-route-id="@Model.PartyId" method="post" class="wizard-form" data-party-form>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="PartyId" />
    <partial name="_Form" model="Model" />

    <div class="form-actions">
        <a class="btn ghost" asp-action="Index">Cancel</a>
        <button class="btn primary" type="submit">Save changes</button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const toast = (message, isError) => {
                const node = document.createElement('div');
                node.className = 'toast' + (isError ? ' is-error' : '');
                node.textContent = message || (isError ? 'Something went wrong.' : 'Done.');
                document.body.appendChild(node);
                setTimeout(() => node.classList.add('hide'), 3200);
                setTimeout(() => node.remove(), 3800);
            };

            const clearFieldErrors = (form) => {
                const messages = form.querySelectorAll('[data-valmsg-for]');
                messages.forEach((m) => {
                    m.textContent = '';
                });
            };

            const setFieldError = (form, fieldName, message) => {
                const msg = form.querySelector('[data-valmsg-for="' + CSS.escape(fieldName) + '"]');
                if (msg) {
                    msg.textContent = message || '';
                }
            };

            const validateClient = (form) => {
                let ok = true;
                const partyName = form.querySelector('#PartyName');
                const partyType = form.querySelector('#PartyTypeId');
                const partyCategory = form.querySelector('#PartyCategoryId');

                if (partyName && !partyName.value.trim()) {
                    setFieldError(form, 'PartyName', 'Party name is required.');
                    ok = false;
                }

                if (partyType && !partyType.value) {
                    setFieldError(form, 'PartyTypeId', 'Party type is required.');
                    ok = false;
                }

                if (partyCategory && !partyCategory.value) {
                    setFieldError(form, 'PartyCategoryId', 'Party category is required.');
                    ok = false;
                }

                const acc = form.querySelector('#AccountNumber');
                const confirm = form.querySelector('#ReEnterAccountNumber');
                if (acc && confirm) {
                    const a = (acc.value || '').trim();
                    const b = (confirm.value || '').trim();
                    if (a && !b) {
                        setFieldError(form, 'ReEnterAccountNumber', 'Please re-enter the account number.');
                        ok = false;
                    } else if (!a && b) {
                        setFieldError(form, 'AccountNumber', 'Enter the account number first.');
                        ok = false;
                    } else if (a && b && a !== b) {
                        setFieldError(form, 'ReEnterAccountNumber', 'Account numbers do not match.');
                        ok = false;
                    }
                }

                return ok;
            };

            const populateSelect = (select, items, idKey, nameKey) => {
                if (!select) return;
                const current = select.value;
                select.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Choose...';
                select.appendChild(placeholder);
                (items || []).forEach((it) => {
                    const opt = document.createElement('option');
                    opt.value = String(it[idKey]);
                    opt.textContent = it[nameKey];
                    select.appendChild(opt);
                });
                if (current) {
                    select.value = current;
                }
                select.dispatchEvent(new Event('change', { bubbles: true }));
            };

            const form = document.querySelector('[data-party-form]');
            if (!form) return;

            (async () => {
                try {
                    const res = await fetch('@Url.Action("Lookups", "Parties")', { headers: { 'Accept': 'application/json' } });
                    if (!res.ok) throw new Error('Failed to load dropdowns.');
                    const data = await res.json();
                    populateSelect(form.querySelector('#PartyTypeId'), data.partyTypes, 'partyTypeId', 'typeName');
                    populateSelect(form.querySelector('#PartyCategoryId'), data.partyCategories, 'partyCategoryId', 'categoryName');
                } catch (e) {
                    toast('Unable to load dropdown data. Please refresh.', true);
                }
            })();

            // Business-profile style dropdown UI
            (function () {
                function enhanceSelect(select) {
                    if (!select || select.dataset.bpSelectEnhanced === "true") return;

                    var wrapper = document.createElement("div");
                    wrapper.className = "bp-select";
                    select.classList.add("bp-select__native");

                    var button = document.createElement("button");
                    button.type = "button";
                    button.className = "bp-select__button";
                    button.setAttribute("aria-haspopup", "listbox");
                    button.setAttribute("aria-expanded", "false");

                    var labelSpan = document.createElement("span");
                    labelSpan.className = "bp-select__label";
                    button.appendChild(labelSpan);

                    var menu = document.createElement("div");
                    menu.className = "bp-select__menu";
                    menu.setAttribute("role", "listbox");
                    menu.style.display = "none";
                    document.body.appendChild(menu);

                    function getSelectedText() {
                        var opt = select.options[select.selectedIndex];
                        return opt ? opt.text : "Choose...";
                    }

                    function syncButtonLabel() {
                        labelSpan.textContent = getSelectedText();
                        button.classList.toggle("is-placeholder", !select.value);
                    }

                    function buildMenu() {
                        menu.innerHTML = "";
                        for (var i = 0; i < select.options.length; i++) {
                            var opt = select.options[i];
                            var item = document.createElement("button");
                            item.type = "button";
                            item.className = "bp-select__option";
                            item.setAttribute("role", "option");
                            item.setAttribute("data-value", opt.value);
                            item.textContent = opt.text;
                            if (opt.disabled) {
                                item.disabled = true;
                                item.setAttribute("aria-disabled", "true");
                            }
                            if (opt.value === select.value) {
                                item.classList.add("is-selected");
                                item.setAttribute("aria-selected", "true");
                            } else {
                                item.setAttribute("aria-selected", "false");
                            }
                            menu.appendChild(item);
                        }
                    }

                    function positionMenu() {
                        var rect = button.getBoundingClientRect();
                        var maxHeight = Math.max(220, window.innerHeight - rect.bottom - 16);
                        menu.style.position = "fixed";
                        menu.style.left = rect.left + "px";
                        menu.style.top = (rect.bottom + 8) + "px";
                        menu.style.width = rect.width + "px";
                        menu.style.maxHeight = maxHeight + "px";
                    }

                    function openMenu() {
                        buildMenu();
                        positionMenu();
                        menu.style.display = "block";
                        button.setAttribute("aria-expanded", "true");
                        var selected = menu.querySelector(".bp-select__option.is-selected");
                        if (selected && selected.scrollIntoView) {
                            selected.scrollIntoView({ block: "nearest" });
                        }
                    }

                    function closeMenu() {
                        menu.style.display = "none";
                        button.setAttribute("aria-expanded", "false");
                    }

                    function isOpen() {
                        return menu.style.display !== "none";
                    }

                    button.addEventListener("click", function () {
                        if (isOpen()) closeMenu();
                        else openMenu();
                    });

                    menu.addEventListener("click", function (e) {
                        var target = e.target;
                        if (!target || !target.classList || !target.classList.contains("bp-select__option")) return;
                        var value = target.getAttribute("data-value");
                        select.value = value;
                        select.dispatchEvent(new Event("change", { bubbles: true }));
                        syncButtonLabel();
                        closeMenu();
                    });

                    select.addEventListener("change", function () {
                        syncButtonLabel();
                    });

                    document.addEventListener("click", function (e) {
                        if (!isOpen()) return;
                        var t = e.target;
                        if (t === button || button.contains(t) || t === menu || menu.contains(t)) return;
                        closeMenu();
                    }, true);

                    document.addEventListener("keydown", function (e) {
                        if (!isOpen()) return;
                        if (e.key === "Escape") {
                            e.preventDefault();
                            closeMenu();
                            button.focus();
                        }
                    });

                    window.addEventListener("resize", function () {
                        if (!isOpen()) return;
                        positionMenu();
                    });

                    window.addEventListener("scroll", function () {
                        if (!isOpen()) return;
                        positionMenu();
                    }, true);

                    select.parentNode.insertBefore(wrapper, select);
                    wrapper.appendChild(select);
                    wrapper.appendChild(button);

                    select.dataset.bpSelectEnhanced = "true";
                    syncButtonLabel();
                }

                var selects = document.querySelectorAll('select[data-bp-select="true"]');
                for (var i = 0; i < selects.length; i++) {
                    enhanceSelect(selects[i]);
                }
            })();

            // Same as billing
            (() => {
                const billing = document.querySelector('[data-billing-address]');
                const shipping = document.querySelector('[data-shipping-address]');
                const checkbox = document.querySelector('[data-same-as-billing]');
                if (!billing || !shipping || !checkbox) return;

                const apply = () => {
                    const same = checkbox.checked;
                    if (same) {
                        shipping.value = billing.value;
                    }
                    shipping.readOnly = same;
                };
                checkbox.addEventListener('change', apply);
                billing.addEventListener('input', () => {
                    if (checkbox.checked) shipping.value = billing.value;
                });
                apply();
            })();

            // AJAX submit
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                clearFieldErrors(form);

                if (!validateClient(form)) {
                    toast('Please fix the highlighted fields.', true);
                    return;
                }

                const fd = new FormData(form);
                try {
                    const res = await fetch(form.getAttribute('action') || window.location.href, {
                        method: 'POST',
                        body: fd,
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    const payload = await res.json().catch(() => null);
                    if (!res.ok) {
                        const errors = payload && payload.errors ? payload.errors : null;
                        if (errors) {
                            Object.keys(errors).forEach((key) => {
                                const messages = errors[key];
                                setFieldError(form, key, Array.isArray(messages) ? (messages[0] || '') : String(messages));
                            });
                        }
                        toast((payload && payload.message) || 'Unable to update party.', true);
                        return;
                    }
                    toast((payload && payload.message) || 'Party updated.', false);
                } catch (err) {
                    toast('Network error while saving. Please try again.', true);
                }
            });
        })();
    </script>
}

