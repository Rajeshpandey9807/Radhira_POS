@model PosApp.Web.Features.BusinessProfiles.BusinessProfileFormViewModel
@{
    ViewData["Title"] = "Business profile";
}

@section Styles {
    <link rel="stylesheet" href="~/css/business-profile.css" asp-append-version="true" />
}

<section class="users-header">
    <div class="bp-shell">
        <p class="eyebrow">Business setup</p>
        <h2>Add Business Details</h2>
        <div class="bp-note">
            <strong>Note:</strong> Details added below will be shown on your Invoices
        </div>
    </div>
</section>

<form asp-action="Index" method="post" enctype="multipart/form-data" class="card-form">
    <partial name="_Form" model="Model" />
    <div class="form-actions">
        <button class="btn primary" type="submit">Save business profile</button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            function wireImagePreview(inputId, imgId, placeholderId) {
                var input = document.getElementById(inputId);
                var img = document.getElementById(imgId);
                var placeholder = document.getElementById(placeholderId);
                if (!input || !img) return;

                input.addEventListener("change", function () {
                    var file = input.files && input.files[0];
                    if (!file) {
                        img.style.display = "none";
                        img.removeAttribute("src");
                        if (placeholder) placeholder.style.display = "block";
                        return;
                    }

                    if (!file.type || !file.type.startsWith("image/")) {
                        img.style.display = "none";
                        img.removeAttribute("src");
                        if (placeholder) placeholder.style.display = "block";
                        return;
                    }

                    var url = URL.createObjectURL(file);
                    img.onload = function () { URL.revokeObjectURL(url); };
                    img.src = url;
                    img.style.display = "block";
                    if (placeholder) placeholder.style.display = "none";
                });
            }

            function syncGstNumberVisibility() {
                var gstSelect = document.getElementById("IsGstRegistered");
                var gstGroup = document.getElementById("gstNumberGroup");
                var gstInput = document.getElementById("GstNumber");
                if (!gstSelect || !gstGroup || !gstInput) return;

                var isYes = gstSelect.value === "true";
                gstGroup.classList.toggle("bp-hidden", !isYes);
                if (isYes) {
                    gstInput.setAttribute("required", "required");
                } else {
                    gstInput.removeAttribute("required");
                    gstInput.value = "";
                }
            }

            wireImagePreview("BusinessLogoFile", "BusinessLogoPreview", "BusinessLogoPlaceholder");
            wireImagePreview("SignatureFile", "SignaturePreview", "SignaturePlaceholder");

            function wireBusinessTypePicker() {
                var picker = document.getElementById("BusinessTypePicker");
                var chips = document.getElementById("SelectedBusinessTypesChips");
                var inputs = document.getElementById("SelectedBusinessTypesInputs");
                if (!picker || !chips || !inputs) return;

                function hasId(id) {
                    return !!inputs.querySelector('input[type="hidden"][name="SelectedBusinessTypeIds"][value="' + id + '"]');
                }

                function addId(id, label) {
                    if (!id || hasId(id)) return;

                    var hidden = document.createElement("input");
                    hidden.type = "hidden";
                    hidden.name = "SelectedBusinessTypeIds";
                    hidden.value = id;
                    hidden.setAttribute("data-id", id);
                    inputs.appendChild(hidden);

                    var chip = document.createElement("span");
                    chip.className = "bp-chip";
                    chip.setAttribute("data-id", id);

                    var chipLabel = document.createElement("span");
                    chipLabel.className = "bp-chip__label";
                    chipLabel.textContent = label || ("Type " + id);

                    var remove = document.createElement("button");
                    remove.type = "button";
                    remove.className = "bp-chip__remove";
                    remove.setAttribute("aria-label", "Remove " + (label || "selected business type"));
                    remove.innerHTML = "&times;";

                    chip.appendChild(chipLabel);
                    chip.appendChild(remove);
                    chips.appendChild(chip);
                }

                picker.addEventListener("change", function () {
                    var selectedOption = picker.options[picker.selectedIndex];
                    var id = picker.value;
                    if (!id) return;
                    addId(id, selectedOption ? selectedOption.text : "");
                    picker.value = "";
                });

                chips.addEventListener("click", function (e) {
                    var target = e.target;
                    if (!target || !target.classList || !target.classList.contains("bp-chip__remove")) return;
                    var chip = target.closest(".bp-chip");
                    if (!chip) return;
                    var id = chip.getAttribute("data-id");
                    if (!id) return;

                    var hidden = inputs.querySelector('input[type="hidden"][name="SelectedBusinessTypeIds"][value="' + id + '"]');
                    if (hidden) hidden.remove();
                    chip.remove();
                });
            }

            wireBusinessTypePicker();

            var gstSelect = document.getElementById("IsGstRegistered");
            if (gstSelect) {
                gstSelect.addEventListener("change", syncGstNumberVisibility);
            }
            syncGstNumberVisibility();
        })();
    </script>
}

