@model PosApp.Web.Features.Products.ProductEditRequest
@{
    ViewData["Title"] = "Edit Product";
}

<header class="page-header">
    <div class="page-header__copy">
        <p class="eyebrow">Item</p>
        <h2>Edit Product</h2>
        <p>Update product details, pricing, GST, and stock information.</p>
    </div>
    <div class="page-header__actions">
        <a asp-controller="Items" asp-action="Inventory" class="btn ghost">Back to Inventory</a>
    </div>
</header>

<form class="form" asp-controller="Items" asp-action="Edit" asp-route-id="@Model.ProductId" method="post" aria-label="Edit product" id="productForm">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ProductId" />
    
    <div asp-validation-summary="ModelOnly" class="validation-summary"></div>
    
    <fieldset class="card">
        <legend class="card__legend">SECTION 1: Basic Details</legend>

        <div class="form-grid">
            <div class="field">
                <label asp-for="ProductTypeId">Product Type</label>
                <select asp-for="ProductTypeId" id="productType" required>
                    <option value="" disabled>Select product type</option>
                </select>
                <span asp-validation-for="ProductTypeId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="CategoryId">Category</label>
                <select asp-for="CategoryId" id="category" required>
                    <option value="" disabled>Select category</option>
                </select>
                <span asp-validation-for="CategoryId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="ItemName">Item Name</label>
                <input asp-for="ItemName" type="text" placeholder="e.g., Premium A4 Paper" required />
                <span asp-validation-for="ItemName" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="SalesPrice">Sales Price</label>
                <input asp-for="SalesPrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                <span asp-validation-for="SalesPrice" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="GstRateId">GST Tax Rate (%)</label>
                <select asp-for="GstRateId" id="gstRateBasic">
                    <option value="" disabled>Select GST rate</option>
                </select>
                <span asp-validation-for="GstRateId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="UnitId">Measuring Unit</label>
                <select asp-for="UnitId" id="unitBasic">
                    <option value="" disabled>Select unit</option>
                </select>
                <span asp-validation-for="UnitId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="OpeningStock">Opening Stock</label>
                <input asp-for="OpeningStock" type="number" step="1" min="0" placeholder="0" />
                <span asp-validation-for="OpeningStock" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="IsActive">Status</label>
                <div class="checkbox-row">
                    <input asp-for="IsActive" type="checkbox" />
                    <span>Active</span>
                </div>
            </div>
        </div>
    </fieldset>

    <fieldset class="card">
        <legend class="card__legend">SECTION 2: Advanced Details</legend>

        <div class="split-grid">
            <section class="card card--sub" aria-label="Stock Details">
                <div class="card__header">
                    <h3 class="card__title">SUB-SECTION A: Stock Details</h3>
                    <p class="card__subtitle">Codes, description, unit, and as-of date.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label asp-for="ItemCode">Item Code</label>
                        <input asp-for="ItemCode" type="text" placeholder="e.g., PAP-A4-80G" />
                        <span asp-validation-for="ItemCode" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label asp-for="HSNCode">HSN Code</label>
                        <input asp-for="HSNCode" type="text" placeholder="e.g., 4802" />
                        <span asp-validation-for="HSNCode" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label asp-for="AsOfDate">As Of Date</label>
                        <input asp-for="AsOfDate" type="date" />
                        <span asp-validation-for="AsOfDate" class="field-validation-error"></span>
                    </div>

                    <div class="field field--full">
                        <label asp-for="Description">Description</label>
                        <textarea asp-for="Description" rows="4" placeholder="Optional notes about this product"></textarea>
                        <span asp-validation-for="Description" class="field-validation-error"></span>
                    </div>
                </div>
            </section>

            <section class="card card--sub" aria-label="Pricing Details">
                <div class="card__header">
                    <h3 class="card__title">SUB-SECTION B: Pricing Details</h3>
                    <p class="card__subtitle">Sales, MRP, purchase, and GST.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label asp-for="MRP">MRP</label>
                        <input asp-for="MRP" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                        <span asp-validation-for="MRP" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label asp-for="PurchasePrice">Purchase Price</label>
                        <input asp-for="PurchasePrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                        <span asp-validation-for="PurchasePrice" class="field-validation-error"></span>
                    </div>
                </div>
            </section>
        </div>

        <div class="action-bar" role="group" aria-label="Form actions">
            <div class="action-bar__left">
                <span class="hint">Product ID: @Model.ProductId</span>
            </div>
            <div class="action-bar__right">
                <a asp-controller="Items" asp-action="Inventory" class="btn ghost">Cancel</a>
                <button type="submit" class="btn primary">Update</button>
            </div>
        </div>
    </fieldset>
</form>

@section Scripts {
    <script>
        (function () {
            const selectedProductTypeId = '@Model.ProductTypeId';
            const selectedCategoryId = '@Model.CategoryId';
            const selectedUnitId = '@Model.UnitId';
            const selectedGstRateId = '@Model.GstRateId';

            // Load lookup data from API
            async function loadLookups() {
                try {
                    const response = await fetch('/Items/Lookups', {
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!response.ok) throw new Error('Failed to load lookups');
                    const data = await response.json();

                    // Populate Product Types
                    const productTypeSelect = document.getElementById('productType');
                    if (productTypeSelect && data.productTypes) {
                        data.productTypes.forEach(function (pt) {
                            const option = document.createElement('option');
                            option.value = pt.productTypeId;
                            option.textContent = pt.typeName;
                            if (pt.productTypeId.toString() === selectedProductTypeId) {
                                option.selected = true;
                            }
                            productTypeSelect.appendChild(option);
                        });
                    }

                    // Populate Categories
                    const categorySelect = document.getElementById('category');
                    if (categorySelect && data.categories) {
                        data.categories.forEach(function (cat) {
                            const option = document.createElement('option');
                            option.value = cat.categoryId;
                            option.textContent = cat.categoryName;
                            if (cat.categoryId.toString() === selectedCategoryId) {
                                option.selected = true;
                            }
                            categorySelect.appendChild(option);
                        });
                    }

                    // Populate Units
                    const unitSelect = document.getElementById('unitBasic');
                    if (unitSelect && data.units) {
                        data.units.forEach(function (unit) {
                            const option = document.createElement('option');
                            option.value = unit.unitId;
                            option.textContent = unit.unitName;
                            if (unit.unitId.toString() === selectedUnitId) {
                                option.selected = true;
                            }
                            unitSelect.appendChild(option);
                        });
                    }

                    // Populate GST Rates
                    const gstSelect = document.getElementById('gstRateBasic');
                    if (gstSelect && data.gstRates) {
                        data.gstRates.forEach(function (rate) {
                            const option = document.createElement('option');
                            option.value = rate.gstRateId;
                            option.textContent = rate.rateName;
                            if (rate.gstRateId.toString() === selectedGstRateId) {
                                option.selected = true;
                            }
                            gstSelect.appendChild(option);
                        });
                    }

                } catch (error) {
                    console.error('Error loading lookups:', error);
                }
            }

            // Initialize on page load
            loadLookups();
        })();
    </script>
}
