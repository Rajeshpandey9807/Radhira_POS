@model PosApp.Web.Features.Products.CreateProductRequest
@{
    ViewData["Title"] = "Add New Product";
    var productTypes = ViewData["ProductTypes"] as IReadOnlyList<PosApp.Web.Features.Products.ProductTypeOption> ?? new List<PosApp.Web.Features.Products.ProductTypeOption>();
    var categories = ViewData["Categories"] as IReadOnlyList<PosApp.Web.Features.Products.CategoryOption> ?? new List<PosApp.Web.Features.Products.CategoryOption>();
    var units = ViewData["Units"] as IReadOnlyList<PosApp.Web.Features.Products.UnitOption> ?? new List<PosApp.Web.Features.Products.UnitOption>();
    var gstRates = ViewData["GstRates"] as IReadOnlyList<PosApp.Web.Features.Products.GstRateOption> ?? new List<PosApp.Web.Features.Products.GstRateOption>();
}

<header class="page-header">
    <div class="page-header__copy">
        <p class="eyebrow">Item</p>
        <h2>Add New Product</h2>
        <p>Create a new product with pricing, GST, and stock details.</p>
    </div>
    <div class="page-header__actions">
        <a asp-controller="Items" asp-action="Inventory" class="btn ghost">Back to Inventory</a>
    </div>
</header>

<nav class="steps" aria-label="Product form steps">
    <ol class="steps__list">
        <li class="steps__item is-active">
            <span class="steps__dot" aria-hidden="true"></span>
            <span class="steps__label">Basic Details</span>
        </li>
        <li class="steps__item">
            <span class="steps__dot" aria-hidden="true"></span>
            <span class="steps__label">Advanced Details</span>
        </li>
    </ol>
</nav>

<form class="form" asp-controller="Items" asp-action="Create" method="post" aria-label="Add new product">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="All" class="text-danger"></div>
    
    <fieldset class="card">
        <legend class="card__legend">SECTION 1: Basic Details</legend>

        <div class="form-grid">
            <div class="field">
                <label asp-for="ProductTypeId">Product Type</label>
                <select asp-for="ProductTypeId" asp-items="@(new SelectList(productTypes, nameof(PosApp.Web.Features.Products.ProductTypeOption.ProductTypeId), nameof(PosApp.Web.Features.Products.ProductTypeOption.ProductTypeName)))" required>
                    <option value="">Select product type</option>
                </select>
                <span asp-validation-for="ProductTypeId" class="text-danger"></span>
            </div>

            <div class="field">
                <label asp-for="CategoryId">Category</label>
                <select asp-for="CategoryId" asp-items="@(new SelectList(categories, nameof(PosApp.Web.Features.Products.CategoryOption.CategoryId), nameof(PosApp.Web.Features.Products.CategoryOption.CategoryName)))">
                    <option value="">Select category</option>
                </select>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>

            <div class="field">
                <label asp-for="ItemName">Item Name</label>
                <input asp-for="ItemName" type="text" placeholder="e.g., Premium A4 Paper" />
                <span asp-validation-for="ItemName" class="text-danger"></span>
            </div>

            <div class="field">
                <label asp-for="SalesPrice">Sales Price</label>
                <input asp-for="SalesPrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" id="salesPriceBasic" />
                <span asp-validation-for="SalesPrice" class="text-danger"></span>
            </div>

            <div class="field">
                <label asp-for="GstRateId">GST Tax Rate (%)</label>
                <select asp-for="GstRateId" id="gstRateBasic">
                    <option value="">Select GST rate</option>
                    @foreach (var rate in gstRates)
                    {
                        <option value="@rate.GstRateId">@rate.Rate%</option>
                    }
                </select>
                <span asp-validation-for="GstRateId" class="text-danger"></span>
            </div>

            <div class="field">
                <label asp-for="UnitId">Measuring Unit</label>
                <select asp-for="UnitId" asp-items="@(new SelectList(units, nameof(PosApp.Web.Features.Products.UnitOption.UnitId), nameof(PosApp.Web.Features.Products.UnitOption.UnitName)))" id="unitBasic">
                    <option value="">Select unit</option>
                </select>
                <span asp-validation-for="UnitId" class="text-danger"></span>
            </div>

            <div class="field">
                <label asp-for="OpeningStock">Opening Stock</label>
                <input asp-for="OpeningStock" type="number" step="0.01" min="0" placeholder="0" />
                <span asp-validation-for="OpeningStock" class="text-danger"></span>
            </div>
        </div>
    </fieldset>

    <fieldset class="card">
        <legend class="card__legend">SECTION 2: Advanced Details</legend>

        <div class="split-grid">
            <section class="card card--sub" aria-label="Stock Details">
                <div class="card__header">
                    <h3 class="card__title">SUB-SECTION A: Stock Details</h3>
                    <p class="card__subtitle">Codes, description, unit, and as-of date.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label asp-for="ItemCode">Item Code</label>
                        <div class="input-row">
                            <input asp-for="ItemCode" type="text" placeholder="e.g., PAP-A4-80G" />
                            <button type="button" class="btn ghost btn--sm" id="autoGenerateCode" aria-label="Auto-generate item code">Auto-generate</button>
                        </div>
                        <p class="help-text">You can enter a custom code or use auto-generate.</p>
                        <span asp-validation-for="ItemCode" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label asp-for="HSNCode">HSN Code</label>
                        <input asp-for="HSNCode" type="text" placeholder="e.g., 4802" />
                        <span asp-validation-for="HSNCode" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label asp-for="UnitId">Measuring Unit</label>
                        <select asp-for="UnitId" asp-items="@(new SelectList(units, nameof(PosApp.Web.Features.Products.UnitOption.UnitId), nameof(PosApp.Web.Features.Products.UnitOption.UnitName)))" id="unitAdvanced">
                            <option value="">Select unit</option>
                        </select>
                        <span asp-validation-for="UnitId" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label asp-for="AsOfDate">As Of Date</label>
                        <input asp-for="AsOfDate" type="date" />
                        <span asp-validation-for="AsOfDate" class="text-danger"></span>
                    </div>

                    <div class="field field--full">
                        <label asp-for="Description">Description</label>
                        <textarea asp-for="Description" rows="4" placeholder="Optional notes about this product"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                </div>
            </section>

            <section class="card card--sub" aria-label="Pricing Details">
                <div class="card__header">
                    <h3 class="card__title">SUB-SECTION B: Pricing Details</h3>
                    <p class="card__subtitle">Sales, MRP, purchase, and GST.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label asp-for="SalesPrice">Sales Price</label>
                        <input asp-for="SalesPrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" id="salesPriceAdvanced" />
                        <span asp-validation-for="SalesPrice" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label asp-for="MRP">MRP</label>
                        <input asp-for="MRP" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                        <span asp-validation-for="MRP" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label asp-for="PurchasePrice">Purchase Price</label>
                        <input asp-for="PurchasePrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                        <span asp-validation-for="PurchasePrice" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label asp-for="GstRateId">GST Tax Rate (%)</label>
                        <select asp-for="GstRateId" id="gstRateAdvanced">
                            <option value="">Select GST rate</option>
                            @foreach (var rate in gstRates)
                            {
                                <option value="@rate.GstRateId">@rate.Rate%</option>
                            }
                        </select>
                        <span asp-validation-for="GstRateId" class="text-danger"></span>
                    </div>
                </div>
            </section>
        </div>

        <div class="action-bar" role="group" aria-label="Form actions">
            <div class="action-bar__left">
                <span class="hint">Tip: keep Item Code short and consistent.</span>
            </div>
            <div class="action-bar__right">
                <a asp-controller="Items" asp-action="Inventory" class="btn ghost">Cancel</a>
                <button type="submit" name="action" value="saveAndNew" class="btn ghost">Save &amp; New</button>
                <button type="submit" name="action" value="save" class="btn primary">Save</button>
            </div>
        </div>
    </fieldset>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Sync basic and advanced fields
        document.getElementById('salesPriceBasic')?.addEventListener('input', function() {
            const advanced = document.getElementById('salesPriceAdvanced');
            if (advanced && !advanced.value) {
                advanced.value = this.value;
            }
        });
        
        document.getElementById('salesPriceAdvanced')?.addEventListener('input', function() {
            const basic = document.getElementById('salesPriceBasic');
            if (basic && !basic.value) {
                basic.value = this.value;
            }
        });

        document.getElementById('gstRateBasic')?.addEventListener('change', function() {
            const advanced = document.getElementById('gstRateAdvanced');
            if (advanced && !advanced.value) {
                advanced.value = this.value;
            }
        });

        document.getElementById('gstRateAdvanced')?.addEventListener('change', function() {
            const basic = document.getElementById('gstRateBasic');
            if (basic && !basic.value) {
                basic.value = this.value;
            }
        });

        document.getElementById('unitBasic')?.addEventListener('change', function() {
            const advanced = document.getElementById('unitAdvanced');
            if (advanced && !advanced.value) {
                advanced.value = this.value;
            }
        });

        document.getElementById('unitAdvanced')?.addEventListener('change', function() {
            const basic = document.getElementById('unitBasic');
            if (basic && !basic.value) {
                basic.value = this.value;
            }
        });

        // Auto-generate item code
        document.getElementById('autoGenerateCode')?.addEventListener('click', function() {
            const itemName = document.getElementById('ItemName')?.value || '';
            const category = document.getElementById('CategoryId')?.selectedOptions[0]?.text || '';
            if (itemName) {
                const code = itemName.substring(0, 3).toUpperCase().replace(/\s/g, '') + 
                           '-' + category.substring(0, 3).toUpperCase().replace(/\s/g, '') + 
                           '-' + Math.floor(Math.random() * 1000);
                document.getElementById('ItemCode').value = code;
            }
        });
    </script>
}
