@model PosApp.Web.Features.Products.ProductCreateRequest
@{
    ViewData["Title"] = "Add New Product";
}

<header class="page-header">
    <div class="page-header__copy">
        <p class="eyebrow">Item</p>
        <h2>Add New Product</h2>
        <p>Create a new product with pricing, GST, and stock details.</p>
    </div>
    <div class="page-header__actions">
        <a asp-controller="Items" asp-action="Inventory" class="btn ghost">Back to Inventory</a>
    </div>
</header>

<nav class="steps" aria-label="Product form steps">
    <ol class="steps__list">
        <li class="steps__item is-active">
            <span class="steps__dot" aria-hidden="true"></span>
            <span class="steps__label">Basic Details</span>
        </li>
        <li class="steps__item">
            <span class="steps__dot" aria-hidden="true"></span>
            <span class="steps__label">Advanced Details</span>
        </li>
    </ol>
</nav>

<form class="form" asp-controller="Items" asp-action="Create" method="post" aria-label="Add new product" id="productForm">
    @Html.AntiForgeryToken()
    
    <div asp-validation-summary="ModelOnly" class="validation-summary"></div>
    
    <fieldset class="card">
        <legend class="card__legend">SECTION 1: Basic Details</legend>

        <div class="form-grid">
            <div class="field">
                <label asp-for="ProductTypeId">Product Type</label>
                @* Product Type dropdown: Dynamically populated from ProductTypes table
                   - Value: ProductTypeId (from ProductTypes.ProductTypeId)
                   - Display: TypeName (from ProductTypes.TypeName)
                   - Bound to: ProductTypeId model property *@
                <select asp-for="ProductTypeId" id="productType" required>
                    <option value="" selected disabled>Select product type</option>
                </select>
                <span asp-validation-for="ProductTypeId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="CategoryId">Category</label>
                <select asp-for="CategoryId" id="category" required>
                    <option value="" selected disabled>Select category</option>
                </select>
                <span asp-validation-for="CategoryId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="ItemName">Item Name</label>
                <input asp-for="ItemName" type="text" placeholder="e.g., Premium A4 Paper" required />
                <span asp-validation-for="ItemName" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="SalesPrice">Sales Price</label>
                <input asp-for="SalesPrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                <span asp-validation-for="SalesPrice" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="GstRateId">GST Tax Rate (%)</label>
                <select asp-for="GstRateId" id="gstRateBasic">
                    <option value="" selected disabled>Select GST rate</option>
                </select>
                <span asp-validation-for="GstRateId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="UnitId">Measuring Unit</label>
                <select asp-for="UnitId" id="unitBasic">
                    <option value="" selected disabled>Select unit</option>
                </select>
                <span asp-validation-for="UnitId" class="field-validation-error"></span>
            </div>

            <div class="field">
                <label asp-for="OpeningStock">Opening Stock</label>
                <input asp-for="OpeningStock" type="number" step="1" min="0" placeholder="0" />
                <span asp-validation-for="OpeningStock" class="field-validation-error"></span>
            </div>
        </div>
    </fieldset>

    <fieldset class="card">
        <legend class="card__legend">SECTION 2: Advanced Details</legend>

        <div class="split-grid">
            <section class="card card--sub" aria-label="Stock Details">
                <div class="card__header">
                    <h3 class="card__title">SUB-SECTION A: Stock Details</h3>
                    <p class="card__subtitle">Codes, description, unit, and as-of date.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label asp-for="ItemCode">Item Code</label>
                        <div class="input-row">
                            <input asp-for="ItemCode" type="text" placeholder="e.g., PAP-A4-80G" />
                            <button type="button" class="btn ghost btn--sm" id="autoGenerateCode" aria-label="Auto-generate item code">Auto-generate</button>
                        </div>
                        <p class="help-text">You can enter a custom code or use auto-generate.</p>
                        <span asp-validation-for="ItemCode" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label asp-for="HSNCode">HSN Code</label>
                        <input asp-for="HSNCode" type="text" placeholder="e.g., 4802" />
                        <span asp-validation-for="HSNCode" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label for="unitAdvanced">Measuring Unit</label>
                        <select id="unitAdvanced" name="unitAdvanced">
                            <option value="" selected disabled>Select unit</option>
                        </select>
                    </div>

                    <div class="field">
                        <label asp-for="AsOfDate">As Of Date</label>
                        <input asp-for="AsOfDate" type="date" />
                        <span asp-validation-for="AsOfDate" class="field-validation-error"></span>
                    </div>

                    <div class="field field--full">
                        <label asp-for="Description">Description</label>
                        <textarea asp-for="Description" rows="4" placeholder="Optional notes about this product"></textarea>
                        <span asp-validation-for="Description" class="field-validation-error"></span>
                    </div>
                </div>
            </section>

            <section class="card card--sub" aria-label="Pricing Details">
                <div class="card__header">
                    <h3 class="card__title">SUB-SECTION B: Pricing Details</h3>
                    <p class="card__subtitle">Sales, MRP, purchase, and GST.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label for="salesPriceAdvanced">Sales Price</label>
                        <input id="salesPriceAdvanced" name="salesPriceAdvanced" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                    </div>

                    <div class="field">
                        <label asp-for="MRP">MRP</label>
                        <input asp-for="MRP" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                        <span asp-validation-for="MRP" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label asp-for="PurchasePrice">Purchase Price</label>
                        <input asp-for="PurchasePrice" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                        <span asp-validation-for="PurchasePrice" class="field-validation-error"></span>
                    </div>

                    <div class="field">
                        <label for="gstRateAdvanced">GST Tax Rate (%)</label>
                        <select id="gstRateAdvanced" name="gstRateAdvanced">
                            <option value="" selected disabled>Select GST rate</option>
                        </select>
                    </div>
                </div>
            </section>
        </div>

        <div class="action-bar" role="group" aria-label="Form actions">
            <div class="action-bar__left">
                <span class="hint">Tip: keep Item Code short and consistent.</span>
            </div>
            <div class="action-bar__right">
                <a asp-controller="Items" asp-action="Inventory" class="btn ghost">Cancel</a>
                <button type="submit" name="submitAction" value="save-new" class="btn ghost">Save &amp; New</button>
                <button type="submit" name="submitAction" value="save" class="btn primary">Save</button>
            </div>
        </div>
    </fieldset>
</form>

@section Scripts {
    <style>
        /* Error styling for dropdowns */
        select.error {
            border-color: #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        select.error option[disabled] {
            color: #dc3545;
            font-weight: 500;
            background-color: rgba(220, 53, 69, 0.15);
        }
        
        select.error:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
    <script>
        (function () {
            // Helper function to show error message in a dropdown
            function showDropdownError(selectElement, errorMessage) {
                if (!selectElement) return;
                
                // Clear all options
                selectElement.innerHTML = '';
                
                // Add error option
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = errorMessage;
                errorOption.disabled = true;
                errorOption.style.color = '#dc3545'; // Red color for error
                selectElement.appendChild(errorOption);
                
                // Add error styling
                selectElement.style.borderColor = '#dc3545';
                selectElement.classList.add('error');
            }

            // Helper function to populate a select dropdown
            function populateSelect(selectElement, items, idKey, nameKey) {
                if (!selectElement) {
                    console.warn('Select element not found');
                    return;
                }
                
                if (!items || items.length === 0) {
                    console.warn('No items to populate:', idKey);
                    showDropdownError(selectElement, `Error: No ${idKey.replace('Id', '')} data available`);
                    return;
                }

                // Clear existing options except the first placeholder
                const placeholder = selectElement.querySelector('option[value=""]');
                const currentValue = selectElement.value;
                selectElement.innerHTML = '';
                
                // Remove error styling
                selectElement.style.borderColor = '';
                selectElement.classList.remove('error');
                
                if (placeholder) {
                    selectElement.appendChild(placeholder);
                }

                // Add options from data
                items.forEach(function (item) {
                    const option = document.createElement('option');
                    // Use camelCase property names (as configured in Program.cs)
                    const id = item[idKey];
                    const name = item[nameKey];
                    
                    if (id !== undefined && id !== null && name) {
                        option.value = String(id);
                        option.textContent = String(name);
                        selectElement.appendChild(option);
                    }
                });

                // Restore previous selection if it still exists
                if (currentValue) {
                    selectElement.value = currentValue;
                }
            }

            // Load lookup data from API
            async function loadLookups() {
                try {
                    console.log('Loading lookups from /Items/Lookups...');
                    const response = await fetch('/Items/Lookups', {
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        // Try to get error details from response
                        let errorDetails = '';
                        try {
                            const errorData = await response.json();
                            errorDetails = errorData.error || errorData.message || response.statusText;
                        } catch (e) {
                            errorDetails = response.statusText;
                        }
                        const error = new Error(`HTTP ${response.status}: ${errorDetails}`);
                        error.response = response;
                        throw error;
                    }
                    
                    const data = await response.json();
                    console.log('Lookup data loaded:', data);

                    // Populate Product Types dropdown
                    // Dynamically binds from ProductTypes table: ProductTypeId (value) and TypeName (display)
                    const productTypeSelect = document.getElementById('productType');
                    if (productTypeSelect) {
                        if (data.productTypes && Array.isArray(data.productTypes) && data.productTypes.length > 0) {
                            populateSelect(productTypeSelect, data.productTypes, 'productTypeId', 'typeName');
                            console.log('Product Types populated:', productTypeSelect.options.length, 'items from ProductTypes table');
                        } else {
                            console.error('No product types found in response');
                            showDropdownError(productTypeSelect, '⚠ Error loading product types');
                        }
                    } else {
                        console.error('Product Type select element (#productType) not found');
                    }

                    // Populate Categories dropdown
                    // Dynamically binds from Categories table: CategoryId (value) and CategoryName (display)
                    // Only shows active categories (IsActive = 1)
                    const categorySelect = document.getElementById('category');
                    if (categorySelect) {
                        if (data.categories && Array.isArray(data.categories) && data.categories.length > 0) {
                            populateSelect(categorySelect, data.categories, 'categoryId', 'categoryName');
                            console.log('Categories populated:', categorySelect.options.length, 'items from Categories table (IsActive = 1)');
                        } else {
                            console.warn('No active categories found in database');
                            // Show user-friendly message when no categories are available
                            categorySelect.innerHTML = '';
                            const noCategoryOption = document.createElement('option');
                            noCategoryOption.value = '';
                            noCategoryOption.textContent = 'Category not available';
                            noCategoryOption.disabled = true;
                            noCategoryOption.style.color = '#6c757d';
                            noCategoryOption.style.fontStyle = 'italic';
                            categorySelect.appendChild(noCategoryOption);
                            categorySelect.disabled = true;
                            categorySelect.style.cursor = 'not-allowed';
                            console.log('Category dropdown disabled - no active categories in database');
                        }
                    } else {
                        console.error('Category select element (#category) not found');
                    }

                    // Populate Units dropdowns
                    const unitSelects = [document.getElementById('unitBasic'), document.getElementById('unitAdvanced')];
                    unitSelects.forEach(function (select) {
                        if (select) {
                            populateSelect(select, data.units, 'unitId', 'unitName');
                        }
                    });

                    // Populate GST Rates dropdowns
                    const gstSelects = [document.getElementById('gstRateBasic'), document.getElementById('gstRateAdvanced')];
                    gstSelects.forEach(function (select) {
                        if (select) {
                            populateSelect(select, data.gstRates, 'gstRateId', 'rateName');
                        }
                    });

                } catch (error) {
                    console.error('Error loading lookups:', error);
                    
                    // Extract error message - the error.message should already contain the detailed error from the response
                    let errorMessage = 'Error loading data';
                    let detailedError = error.message || 'Unknown error';
                    
                    // Parse the error message to extract the actual error details
                    if (error.message && error.message.includes('HTTP 500')) {
                        // The error message should contain the actual error details after the colon
                        const parts = error.message.split(':');
                        if (parts.length > 1) {
                            detailedError = parts.slice(1).join(':').trim();
                            errorMessage = '⚠ ' + detailedError;
                        } else {
                            errorMessage = '⚠ Server error - check console for details';
                        }
                    } else if (error.message && error.message.includes('HTTP 404')) {
                        errorMessage = '⚠ API endpoint not found';
                    } else if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                        errorMessage = '⚠ Network error - check connection';
                    } else if (error.message) {
                        errorMessage = '⚠ ' + error.message;
                    }
                    
                    // Show error messages in both dropdowns
                    const productTypeSelect = document.getElementById('productType');
                    const categorySelect = document.getElementById('category');
                    
                    if (productTypeSelect) {
                        showDropdownError(productTypeSelect, errorMessage + ' (Product Types)');
                    }
                    if (categorySelect) {
                        showDropdownError(categorySelect, errorMessage + ' (Categories)');
                    }
                    
                    // Show user notification with detailed error
                    console.error('Full error details:', error);
                    console.error('Error message:', detailedError);
                    alert('Unable to load dropdown data. Please check the browser console (F12) for detailed error information.\n\nError: ' + detailedError);
                }
            }

            // Generate 8-digit barcode number
            async function generateBarcode() {
                try {
                    const response = await fetch('/Items/GenerateBarcode', {
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    return data.barcode;
                } catch (error) {
                    console.error('Error generating barcode:', error);
                    // Fallback: generate client-side 8-digit number
                    const min = 10000000;
                    const max = 99999999;
                    return Math.floor(Math.random() * (max - min + 1) + min).toString();
                }
            }

            // Auto-generate item code (8-digit barcode)
            document.getElementById('autoGenerateCode')?.addEventListener('click', async function () {
                const itemCodeInput = document.getElementById('ItemCode');
                const button = this;
                
                if (itemCodeInput) {
                    // Disable button while generating
                    button.disabled = true;
                    button.textContent = 'Generating...';
                    
                    try {
                        const barcode = await generateBarcode();
                        itemCodeInput.value = barcode;
                    } catch (error) {
                        console.error('Failed to generate barcode:', error);
                        // Fallback to client-side generation
                        const min = 10000000;
                        const max = 99999999;
                        itemCodeInput.value = Math.floor(Math.random() * (max - min + 1) + min).toString();
                    } finally {
                        // Re-enable button
                        button.disabled = false;
                        button.textContent = 'Auto-generate';
                    }
                }
            });

            // Sync unit dropdowns
            const unitBasic = document.getElementById('unitBasic');
            const unitAdvanced = document.getElementById('unitAdvanced');
            if (unitBasic && unitAdvanced) {
                unitBasic.addEventListener('change', function () {
                    unitAdvanced.value = this.value;
                });
                unitAdvanced.addEventListener('change', function () {
                    unitBasic.value = this.value;
                });
            }

            // Sync GST rate dropdowns
            const gstBasic = document.getElementById('gstRateBasic');
            const gstAdvanced = document.getElementById('gstRateAdvanced');
            if (gstBasic && gstAdvanced) {
                gstBasic.addEventListener('change', function () {
                    gstAdvanced.value = this.value;
                });
                gstAdvanced.addEventListener('change', function () {
                    gstBasic.value = this.value;
                });
            }

            // Sync sales price fields
            const salesBasic = document.getElementById('SalesPrice');
            const salesAdvanced = document.getElementById('salesPriceAdvanced');
            if (salesBasic && salesAdvanced) {
                salesBasic.addEventListener('input', function () {
                    salesAdvanced.value = this.value;
                });
                salesAdvanced.addEventListener('input', function () {
                    salesBasic.value = this.value;
                });
            }

            // Initialize on page load - wait for DOM to be fully ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadLookups);
            } else {
                // DOM is already ready
                loadLookups();
            }
        })();
    </script>
}
