@model UserFormViewModel
@{
    ViewData["Title"] = "Create user";
}

<section class="users-header">
    <div>
        <p class="eyebrow">User creation</p>
        <h2>Create a new user</h2>
        <p>Enter basic details, set credentials, then verify with an OTP.</p>
    </div>
</section>

<section class="card-form wizard-card" aria-label="User creation wizard">
    <div class="wizard-head">
        <ol class="wizard-steps" aria-label="Progress">
            <li class="wizard-step is-active" data-step-indicator="1">
                <span class="wizard-step-pill" aria-hidden="true">1</span>
                <span class="wizard-step-label">Basic details</span>
            </li>
            <li class="wizard-step" data-step-indicator="2">
                <span class="wizard-step-pill" aria-hidden="true">2</span>
                <span class="wizard-step-label">Credentials</span>
            </li>
        </ol>

        <div class="wizard-meta">
            <span class="wizard-meta__title" id="wizardTitle">Step 1 of 2</span>
            <span class="wizard-meta__subtitle">All fields are required.</span>
        </div>
    </div>

    <form id="userCreateWizard" class="wizard-form" novalidate>
        <!-- Keep a role value available (static UI; no submit). -->
        <input type="hidden" name="RoleId" value="@Model.RoleId" />

        <div class="wizard-panel" data-step="1" aria-labelledby="wizardTitle">
            <div class="form-grid">
                <div class="field-group">
                    <label for="displayName">Full Name</label>
                    <input id="displayName"
                           name="DisplayName"
                           type="text"
                           autocomplete="name"
                           placeholder="Jane Doe"
                           required
                           data-validate="name" />
                    <small class="field-hint" data-default="Enter the user’s full name.">Enter the user’s full name.</small>
                </div>

                <div class="field-group">
                    <label for="email">Email Address</label>
                    <input id="email"
                           name="Email"
                           type="email"
                           autocomplete="email"
                           placeholder="jane.doe (at) company.com"
                           required
                           data-validate="email" />
                    <small class="field-hint" data-default="We’ll send the OTP to this email.">We’ll send the OTP to this email.</small>
                </div>

                <div class="field-group">
                    <label for="phoneNumber">Mobile Number</label>
                    <input id="phoneNumber"
                           name="PhoneNumber"
                           type="number"
                           inputmode="numeric"
                           autocomplete="tel"
                           placeholder="5550100"
                           required
                           data-validate="phone" />
                    <small class="field-hint" data-default="Digits only (include country code if needed).">Digits only (include country code if needed).</small>
                </div>
            </div>

            <div class="form-actions wizard-actions">
                <a class="btn ghost" asp-action="Index">Cancel</a>
                <button class="btn primary" type="button" data-next>Next</button>
            </div>
        </div>

        <div class="wizard-panel is-hidden" data-step="2" aria-labelledby="wizardTitle" hidden>
            <div class="form-grid">
                <div class="field-group">
                    <label for="username">Username</label>
                    <input id="username"
                           name="Username"
                           type="text"
                           autocomplete="username"
                           placeholder="jane.doe"
                           required
                           data-validate="username" />
                    <small class="field-hint" data-default="3–32 characters. Letters, numbers, dot or underscore.">3–32 characters. Letters, numbers, dot or underscore.</small>
                </div>

                <div class="field-group">
                    <label for="password">Password</label>
                    <input id="password"
                           name="Password"
                           type="password"
                           autocomplete="new-password"
                           placeholder="••••••••"
                           required
                           data-validate="password" />
                    <small class="field-hint" data-default="Use at least 6 characters.">Use at least 6 characters.</small>
                </div>
            </div>

            <div class="form-actions wizard-actions">
                <button class="btn ghost" type="button" data-back>Back</button>
                <button class="btn primary" type="button" data-confirm>Confirm / Save</button>
            </div>
        </div>
    </form>
</section>

<div class="modal-overlay is-hidden" data-otp-overlay hidden>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="otpTitle" aria-describedby="otpDesc">
        <div class="modal-head">
            <div>
                <p class="eyebrow">Verification</p>
                <h3 id="otpTitle" class="modal-title">Enter OTP</h3>
                <p id="otpDesc" class="modal-subtitle">
                    We sent a 6-digit code to the provided email and mobile number.
                </p>
            </div>
            <button type="button" class="modal-close" data-otp-close aria-label="Close verification">×</button>
        </div>

        <div class="modal-body">
            <div class="field-group">
                <label for="otpCode">One-time password</label>
                <input id="otpCode"
                       type="text"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       maxlength="6"
                       placeholder="123456"
                       required
                       data-validate="otp" />
                <small class="field-hint" data-default="Enter the 6-digit code.">Enter the 6-digit code.</small>
            </div>

            <div class="otp-row">
                <button type="button" class="btn primary" data-otp-verify>Verify</button>
                <button type="button" class="btn ghost" data-otp-cancel>Cancel</button>
                <button type="button" class="otp-link" data-otp-resend disabled aria-disabled="true">Resend code</button>
            </div>

            <div class="otp-result is-hidden" data-otp-result hidden>
                <strong>Verified.</strong>
                <span>This is a static UI demo—no user is actually created.</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const form = document.getElementById('userCreateWizard');
            if (!form) return;

            const stepPanels = Array.from(form.querySelectorAll('[data-step]'));
            const stepIndicators = Array.from(document.querySelectorAll('[data-step-indicator]'));
            const wizardTitle = document.getElementById('wizardTitle');

            const overlay = document.querySelector('[data-otp-overlay]');
            const otpInput = document.getElementById('otpCode');
            const otpResult = document.querySelector('[data-otp-result]');

            const show = (el) => {
                el.classList.remove('is-hidden');
                el.hidden = false;
            };
            const hide = (el) => {
                el.classList.add('is-hidden');
                el.hidden = true;
            };

            const setHint = (input, message, isError) => {
                const group = input.closest('.field-group');
                if (!group) return;
                const hint = group.querySelector('.field-hint');
                if (!hint) return;
                const defaultText = hint.getAttribute('data-default') || '';
                hint.textContent = message ?? defaultText;
                hint.classList.toggle('is-error', Boolean(isError));
                input.setAttribute('aria-invalid', isError ? 'true' : 'false');
            };

            const validators = {
                name: (value) => value.trim().length >= 2 ? null : 'Please enter a full name.',
                email: (value) => {
                    const v = value.trim();
                    if (!v) return 'Email is required.';
                    // Lightweight email sanity check (avoids using a literal '@' to keep Razor happy).
                    const at = String.fromCharCode(64);
                    const atIndex = v.indexOf(at);
                    if (atIndex <= 0 || atIndex !== v.lastIndexOf(at)) return 'Please enter a valid email address.';
                    const domain = v.slice(atIndex + 1);
                    const dotIndex = domain.lastIndexOf('.');
                    if (dotIndex <= 0 || dotIndex >= domain.length - 1) return 'Please enter a valid email address.';
                    return null;
                },
                phone: (value) => {
                    const digits = String(value ?? '').replace(/\D/g, '');
                    if (!digits) return 'Mobile number is required.';
                    return digits.length >= 7 ? null : 'Please enter a valid mobile number.';
                },
                username: (value) => {
                    const v = value.trim();
                    if (!v) return 'Username is required.';
                    if (v.length < 3 || v.length > 32) return 'Username must be 3–32 characters.';
                    return /^[a-zA-Z0-9._]+$/.test(v) ? null : 'Use only letters, numbers, dot or underscore.';
                },
                password: (value) => {
                    const v = String(value ?? '');
                    if (!v) return 'Password is required.';
                    return v.length >= 6 ? null : 'Password must be at least 6 characters.';
                },
                otp: (value) => {
                    const v = String(value ?? '').trim();
                    if (!v) return 'OTP is required.';
                    return /^\d{6}$/.test(v) ? null : 'Enter a 6-digit code.';
                }
            };

            const validateInputs = (inputs) => {
                let ok = true;
                inputs.forEach((input) => {
                    const key = input.getAttribute('data-validate');
                    const validate = key ? validators[key] : null;
                    const message = validate ? validate(input.value) : null;
                    if (message) {
                        ok = false;
                        setHint(input, message, true);
                    } else {
                        setHint(input, null, false);
                    }
                });
                return ok;
            };

            const goToStep = (step) => {
                stepPanels.forEach((panel) => {
                    const isActive = panel.getAttribute('data-step') === String(step);
                    if (isActive) show(panel); else hide(panel);
                });

                stepIndicators.forEach((li) => {
                    li.classList.toggle('is-active', li.getAttribute('data-step-indicator') === String(step));
                });

                if (wizardTitle) {
                    wizardTitle.textContent = 'Step ' + step + ' of 2';
                }
            };

            const openOtp = () => {
                if (!overlay) return;
                show(overlay);
                document.body.classList.add('is-modal-open');
                if (otpResult) hide(otpResult);
                if (otpInput) {
                    otpInput.value = '';
                    setHint(otpInput, null, false);
                    otpInput.focus();
                }
            };

            const closeOtp = () => {
                if (!overlay) return;
                hide(overlay);
                document.body.classList.remove('is-modal-open');
            };

            // This UI is intentionally static. Prevent any native form submission
            // (e.g. pressing Enter inside an input).
            form.addEventListener('submit', (e) => {
                e.preventDefault();
            });

            form.addEventListener('input', (e) => {
                const input = e.target;
                if (!(input instanceof HTMLInputElement)) return;
                if (!input.closest('.field-group')) return;
                if (!input.getAttribute('data-validate')) return;
                setHint(input, null, false);
            });

            document.addEventListener('click', (e) => {
                const target = e.target;
                if (!(target instanceof HTMLElement)) return;

                const nextButton = target.closest('[data-next]');
                const backButton = target.closest('[data-back]');
                const confirmButton = target.closest('[data-confirm]');
                const otpCloseButton = target.closest('[data-otp-close]');
                const otpCancelButton = target.closest('[data-otp-cancel]');
                const otpVerifyButton = target.closest('[data-otp-verify]');

                if (nextButton) {
                    const step1 = stepPanels.find((p) => p.getAttribute('data-step') === '1');
                    const inputs = step1 ? Array.from(step1.querySelectorAll('input[data-validate]')) : [];
                    if (validateInputs(inputs)) {
                        goToStep(2);
                        const first = form.querySelector('[data-step="2"] input');
                        if (first instanceof HTMLInputElement) first.focus();
                    }
                }

                if (backButton) {
                    goToStep(1);
                    const first = form.querySelector('[data-step="1"] input');
                    if (first instanceof HTMLInputElement) first.focus();
                }

                if (confirmButton) {
                    const step2 = stepPanels.find((p) => p.getAttribute('data-step') === '2');
                    const inputs = step2 ? Array.from(step2.querySelectorAll('input[data-validate]')) : [];
                    if (validateInputs(inputs)) {
                        openOtp();
                    }
                }

                if (otpCloseButton || otpCancelButton) {
                    closeOtp();
                }

                if (overlay && target === overlay) {
                    closeOtp();
                }

                if (otpVerifyButton) {
                    if (!otpInput) return;
                    const message = validators.otp(otpInput.value);
                    if (message) {
                        setHint(otpInput, message, true);
                        otpInput.focus();
                        return;
                    }
                    setHint(otpInput, null, false);
                    if (otpResult) show(otpResult);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key !== 'Escape') return;
                if (!overlay || overlay.classList.contains('is-hidden')) return;
                closeOtp();
            });

            // Enter key convenience:
            // - Step 1: Enter -> Next
            // - Step 2: Enter -> Confirm / Save
            // - OTP modal: Enter -> Verify
            form.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;

                const otpOpen = overlay && !overlay.classList.contains('is-hidden');
                if (otpOpen) {
                    e.preventDefault();
                    const verify = document.querySelector('[data-otp-verify]');
                    if (verify instanceof HTMLButtonElement) {
                        verify.click();
                    }
                    return;
                }

                const step1Open = stepPanels.some((p) => p.getAttribute('data-step') === '1' && !p.classList.contains('is-hidden'));
                const action = step1Open ? form.querySelector('[data-next]') : form.querySelector('[data-confirm]');
                if (action instanceof HTMLButtonElement) {
                    e.preventDefault();
                    action.click();
                }
            });

            goToStep(1);
        })();
    </script>
}
